"use strict";function trace(a){"\n"===a[a.length-1]&&(a=a.substring(0,a.length-1)),console.log((window.performance.now()/1e3).toFixed(3)+": "+a)}function maybeFixConfiguration(a){if(a)for(var b=0;b<a.iceServers.length;b++)a.iceServers[b].hasOwnProperty("urls")&&(a.iceServers[b].url=a.iceServers[b].urls,delete a.iceServers[b].urls)}if(!window.console)var console={};console.log||(console.log=function(){});var LZString={_keyStr:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",_f:String.fromCharCode,compressToBase64:function(a){if(null==a)return"";var b,c,d,e,f,g,h,i="",j=0;for(a=LZString.compress(a);j<2*a.length;)j%2==0?(b=a.charCodeAt(j/2)>>8,c=255&a.charCodeAt(j/2),d=j/2+1<a.length?a.charCodeAt(j/2+1)>>8:0/0):(b=255&a.charCodeAt((j-1)/2),(j+1)/2<a.length?(c=a.charCodeAt((j+1)/2)>>8,d=255&a.charCodeAt((j+1)/2)):c=d=0/0),j+=3,e=b>>2,f=(3&b)<<4|c>>4,g=(15&c)<<2|d>>6,h=63&d,isNaN(c)?g=h=64:isNaN(d)&&(h=64),i=i+LZString._keyStr.charAt(e)+LZString._keyStr.charAt(f)+LZString._keyStr.charAt(g)+LZString._keyStr.charAt(h);return i},decompressFromBase64:function(a){if(null==a)return"";var b,c,d,e,f,g,h,i,j="",k=0,l=0,m=LZString._f;for(a=a.replace(/[^A-Za-z0-9\+\/\=]/g,"");l<a.length;)f=LZString._keyStr.indexOf(a.charAt(l++)),g=LZString._keyStr.indexOf(a.charAt(l++)),h=LZString._keyStr.indexOf(a.charAt(l++)),i=LZString._keyStr.indexOf(a.charAt(l++)),c=f<<2|g>>4,d=(15&g)<<4|h>>2,e=(3&h)<<6|i,k%2==0?(b=c<<8,64!=h&&(j+=m(b|d)),64!=i&&(b=e<<8)):(j+=m(b|c),64!=h&&(b=d<<8),64!=i&&(j+=m(b|e))),k+=3;return LZString.decompress(j)},compressToUTF16:function(a){if(null==a)return"";var b,c,d,e="",f=0,g=LZString._f;for(a=LZString.compress(a),b=0;b<a.length;b++)switch(c=a.charCodeAt(b),f++){case 0:e+=g((c>>1)+32),d=(1&c)<<14;break;case 1:e+=g(d+(c>>2)+32),d=(3&c)<<13;break;case 2:e+=g(d+(c>>3)+32),d=(7&c)<<12;break;case 3:e+=g(d+(c>>4)+32),d=(15&c)<<11;break;case 4:e+=g(d+(c>>5)+32),d=(31&c)<<10;break;case 5:e+=g(d+(c>>6)+32),d=(63&c)<<9;break;case 6:e+=g(d+(c>>7)+32),d=(127&c)<<8;break;case 7:e+=g(d+(c>>8)+32),d=(255&c)<<7;break;case 8:e+=g(d+(c>>9)+32),d=(511&c)<<6;break;case 9:e+=g(d+(c>>10)+32),d=(1023&c)<<5;break;case 10:e+=g(d+(c>>11)+32),d=(2047&c)<<4;break;case 11:e+=g(d+(c>>12)+32),d=(4095&c)<<3;break;case 12:e+=g(d+(c>>13)+32),d=(8191&c)<<2;break;case 13:e+=g(d+(c>>14)+32),d=(16383&c)<<1;break;case 14:e+=g(d+(c>>15)+32,(32767&c)+32),f=0}return e+g(d+32)},decompressFromUTF16:function(a){if(null==a)return"";for(var b,c,d="",e=0,f=0,g=LZString._f;f<a.length;){switch(c=a.charCodeAt(f)-32,e++){case 0:b=c<<1;break;case 1:d+=g(b|c>>14),b=(16383&c)<<2;break;case 2:d+=g(b|c>>13),b=(8191&c)<<3;break;case 3:d+=g(b|c>>12),b=(4095&c)<<4;break;case 4:d+=g(b|c>>11),b=(2047&c)<<5;break;case 5:d+=g(b|c>>10),b=(1023&c)<<6;break;case 6:d+=g(b|c>>9),b=(511&c)<<7;break;case 7:d+=g(b|c>>8),b=(255&c)<<8;break;case 8:d+=g(b|c>>7),b=(127&c)<<9;break;case 9:d+=g(b|c>>6),b=(63&c)<<10;break;case 10:d+=g(b|c>>5),b=(31&c)<<11;break;case 11:d+=g(b|c>>4),b=(15&c)<<12;break;case 12:d+=g(b|c>>3),b=(7&c)<<13;break;case 13:d+=g(b|c>>2),b=(3&c)<<14;break;case 14:d+=g(b|c>>1),b=(1&c)<<15;break;case 15:d+=g(b|c),e=0}f++}return LZString.decompress(d)},compress:function(a){if(null==a)return"";var b,c,d,e={},f={},g="",h="",i="",j=2,k=3,l=2,m="",n=0,o=0,p=LZString._f;for(d=0;d<a.length;d+=1)if(g=a.charAt(d),Object.prototype.hasOwnProperty.call(e,g)||(e[g]=k++,f[g]=!0),h=i+g,Object.prototype.hasOwnProperty.call(e,h))i=h;else{if(Object.prototype.hasOwnProperty.call(f,i)){if(i.charCodeAt(0)<256){for(b=0;l>b;b++)n<<=1,15==o?(o=0,m+=p(n),n=0):o++;for(c=i.charCodeAt(0),b=0;8>b;b++)n=n<<1|1&c,15==o?(o=0,m+=p(n),n=0):o++,c>>=1}else{for(c=1,b=0;l>b;b++)n=n<<1|c,15==o?(o=0,m+=p(n),n=0):o++,c=0;for(c=i.charCodeAt(0),b=0;16>b;b++)n=n<<1|1&c,15==o?(o=0,m+=p(n),n=0):o++,c>>=1}j--,0==j&&(j=Math.pow(2,l),l++),delete f[i]}else for(c=e[i],b=0;l>b;b++)n=n<<1|1&c,15==o?(o=0,m+=p(n),n=0):o++,c>>=1;j--,0==j&&(j=Math.pow(2,l),l++),e[h]=k++,i=String(g)}if(""!==i){if(Object.prototype.hasOwnProperty.call(f,i)){if(i.charCodeAt(0)<256){for(b=0;l>b;b++)n<<=1,15==o?(o=0,m+=p(n),n=0):o++;for(c=i.charCodeAt(0),b=0;8>b;b++)n=n<<1|1&c,15==o?(o=0,m+=p(n),n=0):o++,c>>=1}else{for(c=1,b=0;l>b;b++)n=n<<1|c,15==o?(o=0,m+=p(n),n=0):o++,c=0;for(c=i.charCodeAt(0),b=0;16>b;b++)n=n<<1|1&c,15==o?(o=0,m+=p(n),n=0):o++,c>>=1}j--,0==j&&(j=Math.pow(2,l),l++),delete f[i]}else for(c=e[i],b=0;l>b;b++)n=n<<1|1&c,15==o?(o=0,m+=p(n),n=0):o++,c>>=1;j--,0==j&&(j=Math.pow(2,l),l++)}for(c=2,b=0;l>b;b++)n=n<<1|1&c,15==o?(o=0,m+=p(n),n=0):o++,c>>=1;for(;;){if(n<<=1,15==o){m+=p(n);break}o++}return m},decompress:function(a){if(null==a)return"";if(""==a)return null;var b,c,d,e,f,g,h,i,j=[],k=4,l=4,m=3,n="",o="",p=LZString._f,q={string:a,val:a.charCodeAt(0),position:32768,index:1};for(c=0;3>c;c+=1)j[c]=c;for(e=0,g=Math.pow(2,2),h=1;h!=g;)f=q.val&q.position,q.position>>=1,0==q.position&&(q.position=32768,q.val=q.string.charCodeAt(q.index++)),e|=(f>0?1:0)*h,h<<=1;switch(b=e){case 0:for(e=0,g=Math.pow(2,8),h=1;h!=g;)f=q.val&q.position,q.position>>=1,0==q.position&&(q.position=32768,q.val=q.string.charCodeAt(q.index++)),e|=(f>0?1:0)*h,h<<=1;i=p(e);break;case 1:for(e=0,g=Math.pow(2,16),h=1;h!=g;)f=q.val&q.position,q.position>>=1,0==q.position&&(q.position=32768,q.val=q.string.charCodeAt(q.index++)),e|=(f>0?1:0)*h,h<<=1;i=p(e);break;case 2:return""}for(j[3]=i,d=o=i;;){if(q.index>q.string.length)return"";for(e=0,g=Math.pow(2,m),h=1;h!=g;)f=q.val&q.position,q.position>>=1,0==q.position&&(q.position=32768,q.val=q.string.charCodeAt(q.index++)),e|=(f>0?1:0)*h,h<<=1;switch(i=e){case 0:for(e=0,g=Math.pow(2,8),h=1;h!=g;)f=q.val&q.position,q.position>>=1,0==q.position&&(q.position=32768,q.val=q.string.charCodeAt(q.index++)),e|=(f>0?1:0)*h,h<<=1;j[l++]=p(e),i=l-1,k--;break;case 1:for(e=0,g=Math.pow(2,16),h=1;h!=g;)f=q.val&q.position,q.position>>=1,0==q.position&&(q.position=32768,q.val=q.string.charCodeAt(q.index++)),e|=(f>0?1:0)*h,h<<=1;j[l++]=p(e),i=l-1,k--;break;case 2:return o}if(0==k&&(k=Math.pow(2,m),m++),j[i])n=j[i];else{if(i!==l)return null;n=d+d.charAt(0)}o+=n,j[l++]=d+n.charAt(0),k--,d=n,0==k&&(k=Math.pow(2,m),m++)}}};"undefined"!=typeof module&&null!=module&&(module.exports=LZString),function(a){a.viewportSize={},a.viewportSize.getHeight=function(){return b("Height")},a.viewportSize.getWidth=function(){return b("Width")};var b=function(b){var c,d=b.toLowerCase(),e=a.document,f=e.documentElement;if(void 0===a["inner"+b])c=f["client"+b];else if(a["inner"+b]!=f["client"+b]){var g=e.createElement("body");g.id="vpw-test-b",g.style.cssText="overflow:scroll";var h=e.createElement("div");h.id="vpw-test-d",h.style.cssText="position:absolute;top:-1000px",h.innerHTML="<style>@media("+d+":"+f["client"+b]+"px){body#vpw-test-b div#vpw-test-d{"+d+":7px!important}}</style>",g.appendChild(h),f.insertBefore(g,e.head),c=7==h["offset"+b]?f["client"+b]:a["inner"+b],f.removeChild(g)}else c=a["inner"+b];return c}}(this),function(a,b){var c,d;if(a.uaMatch=function(a){a=a.toLowerCase();var b=/(opr)[\/]([\w.]+)/.exec(a)||/(chrome)[ \/]([\w.]+)/.exec(a)||/(version)[ \/]([\w.]+).*(safari)[ \/]([\w.]+)/.exec(a)||/(webkit)[ \/]([\w.]+)/.exec(a)||/(opera)(?:.*version|)[ \/]([\w.]+).*(opera mini)/.exec(a)||/(opera)(?:.*version|)[ \/]([\w.]+)/.exec(a)||/(msie) ([\w.]+)/.exec(a)||a.indexOf("trident")>=0&&/(rv)(?::| )([\w.]+)/.exec(a)||a.indexOf("compatible")<0&&/(mozilla)(?:.*? rv:([\w.]+)|)/.exec(a)||[],c=/(ipad)/.exec(a)||/(iphone)/.exec(a)||/(android)/.exec(a)||/(windows phone)/.exec(a)||/(win)/.exec(a)||/(mac)/.exec(a)||/(linux)/.exec(a)||/(cros)/i.exec(a)||[];return{browser:b[3]||b[1]||"",version:b[2]||"0",platform:c[0]||""}},c=a.uaMatch(b),d={},c.browser&&(d[c.browser]=!0,d.version=c.version,d.versionNumber=parseInt(c.version)),c.platform&&(d[c.platform]=!0),(d.android||d.ipad||d.iphone||d["windows phone"]||d["opera mini"])&&(d.mobile=!0),(d.cros||d.mac||d.linux||d.win)&&(d.desktop=!0),(d.chrome||d.opr||d.safari)&&(d.webkit=!0),d.rv){var e="msie";c.browser=e,d[e]=!0}if(d.opr){var f="opera";c.browser=f,d[f]=!0}if(d.safari&&d.android){var g="android";c.browser=g,d[g]=!0}d.name=c.browser,d.platform=c.platform,a.browser=d}(jQuery,window.navigator.userAgent);var RTCPeerConnection=null,getUserMedia=null,attachMediaStream=null,reattachMediaStream=null,webrtcDetectedBrowser=null,webrtcDetectedVersion=null;if(navigator.mozGetUserMedia)console.log("This appears to be Firefox"),webrtcDetectedBrowser="firefox",webrtcDetectedVersion=parseInt(navigator.userAgent.match(/Firefox\/([0-9]+)\./)[1],10),RTCPeerConnection=function(a,b){return maybeFixConfiguration(a),new mozRTCPeerConnection(a,b)},window.RTCSessionDescription=mozRTCSessionDescription,window.RTCIceCandidate=mozRTCIceCandidate,getUserMedia=navigator.mozGetUserMedia.bind(navigator),navigator.getUserMedia=getUserMedia,window.createIceServer=function(a,b,c){var d=null,e=a.split(":");if(0===e[0].indexOf("stun"))d={url:a};else if(0===e[0].indexOf("turn"))if(27>webrtcDetectedVersion){var f=a.split("?");(1===f.length||0===f[1].indexOf("transport=udp"))&&(d={url:f[0],credential:c,username:b})}else d={url:a,credential:c,username:b};return d},window.createIceServers=function(a,b,c){for(var d=[],e=0;e<a.length;e++){var f=window.createIceServer(a[e],b,c);null!==f&&d.push(f)}return d},attachMediaStream=function(a,b){console.log("Attaching media stream"),a.mozSrcObject=b},reattachMediaStream=function(a,b){console.log("Reattaching media stream"),a.mozSrcObject=b.mozSrcObject};else if(navigator.webkitGetUserMedia){console.log("This appears to be Chrome"),webrtcDetectedBrowser="chrome";var result=navigator.userAgent.match(/Chrom(e|ium)\/([0-9]+)\./);webrtcDetectedVersion=null!==result?parseInt(result[2],10):999,window.createIceServer=function(a,b,c){var d=null,e=a.split(":");return 0===e[0].indexOf("stun")?d={url:a}:0===e[0].indexOf("turn")&&(d={url:a,credential:c,username:b}),d},window.createIceServers=function(a,b,c){var d=[];if(webrtcDetectedVersion>=34)d={urls:a,credential:c,username:b};else for(var e=0;e<a.length;e++){var f=window.createIceServer(a[e],b,c);null!==f&&d.push(f)}return d},RTCPeerConnection=function(a,b){return 34>webrtcDetectedVersion&&maybeFixConfiguration(a),new webkitRTCPeerConnection(a,b)},getUserMedia=navigator.webkitGetUserMedia.bind(navigator),navigator.getUserMedia=getUserMedia,attachMediaStream=function(a,b){"undefined"!=typeof a.srcObject?a.srcObject=b:"undefined"!=typeof a.mozSrcObject?a.mozSrcObject=b:"undefined"!=typeof a.src?a.src=URL.createObjectURL(b):console.log("Error attaching stream to element.")},reattachMediaStream=function(a,b){a.src=b.src}}else console.log("Browser does not appear to be WebRTC-capable");!function(a,b){a.module("scrollGlue.directives",[]).directive("scrollGlue",["$parse",function(a){function c(a){var b=a;return{getValue:function(){return b},setValue:function(a){b=a}}}function d(a,b){return{getValue:function(){return a(b)},setValue:function(){}}}function e(a,b,c){return{getValue:function(){return a(c)},setValue:function(d){d!==a(c)&&c.$apply(function(){b(c,d)})}}}function f(f,g){if(""!==f){var h=a(f);return h.assign!==b?e(h,h.assign,g):d(h,g)}return c(!0)}return{priority:1,restrict:"A",link:function(a,b,c){function d(){i.scrollTop=i.scrollHeight}function e(){j.getValue()&&d()}function g(){return i.scrollTop+i.clientHeight+1>=i.scrollHeight}function h(){j.setValue(g())}var i=b[0],j=f(c.scrollGlue,a);a.$watch(e),b.bind("scroll",h)}}}])}(angular),angular.module("presenceModule",[]).directive("presenceDirective",["$presence","types",function(a,b){function c(a){return a?a.split(" "):b.getAllTypeNames()}return{restrict:"A",link:function(d,e,f){angular.forEach(c(f.presence),function(c){var d=b.get(c);e.on(d.events,function(){a.registerAction(d.name)})})}}}]).factory("types",function(){return{MOUSE:{name:"MOUSE",events:"click mousedown mouseup mousemove"},KEYBOARD:{name:"KEYBOARD",events:"keypress keydown keyup"},TOUCH:{name:"TOUCH",events:"touchstart touchmove touchend touchenter touchleave touchcancel"},getAllTypeNames:function(){return["MOUSE","KEYBOARD","TOUCH"]},get:function(a){if(a=a.toUpperCase(),this[a])return this[a];throw new Error("Unknown type for monitoring presence: "+a)}}}).factory("$presence",["$timeout","$log","orderByFilter","types",function(a,b,c,d){function e(a,b){function e(){return angular.forEach(a,function(b,c){angular.isObject(b)||(a[c]=b={enter:b}),b.name=c,b.enter=b.enter||0,b.isCurrentState=!1}),a}function g(){var b=[];return angular.forEach(a,function(a){b.push(a)}),c(b,"enter")}function h(){angular.forEach(q,function(a,b){a.id=b,a.onEnter=function(a){l(b,a)},a.onLeave=function(a){m(b,a)}})}function i(){a.onChange=function(a){k(a)},a.getCurrent=function(){return n()}}function j(){angular.forEach(q,function(a,b){function c(c){-1===a.accept.toUpperCase().indexOf(c)&&(t[c]=b+1)}a.initial===!0&&(u=b),a.accept&&angular.forEach(d.getAllTypeNames(),c)})}return a=e(),q=g(),h(),i(),j(),b||f(u),a}function f(b){var c=r;q[c]&&(q[c].leftOn=new Date,q[c].isCurrentState=!1),q[b].isCurrentState=!0,q[b].enteredOn=new Date,q[b].enteredFrom=q[c]?q[c].name:void 0,r=b,a(function(){h(v[c]),h(w[b]),h(x)}),i()}function g(){f(r+1)}function h(a){if(a)for(var b=0;b<a.length;b++)a[b](q[r])}function i(){var b=r+1;q[b]&&(a.cancel(s),s=a(g,q[b].enter-q[r].enter))}function j(a){if(q){var b=t[a]||0;r>b?f(b):b===r&&i()}}function k(a){x.push(a)}function l(a,b){(w[a]||(w[a]=[])).push(b)}function m(a,b){(v[a]||(v[a]=[])).push(b)}function n(){return q[r]}function o(){return void 0!==s}function p(a){return o()?void b.info("$presence timer already started"):void f(a&&a.id?a.id:u)}var q,r,s,t={},u=0,v={},w={},x=[];return{init:e,registerAction:j,isActive:o,start:p}}]);var videoApp=angular.module("videoApp",["lxMain.routes","lxChatbox.controllers","lxDebuggingInfo.controllers","lxUseChatRoom.controllers","lxLandingPage.controllers","lxMainView.controllers","lxVideo.controllers","lxPresence.controllers","lxChatbox.directives","lxChatRoom.directives","lxCommon.directives","lxMainVideo.directives","lxLandingPage.directives","lxVideoExchangeUserFeedback.directives","lxAccessSystemResources.services","lxBasicFunctionality.services","lxChannel.services","lxChatbox.services","lxChatRoom.services","lxCodecs.services","lxCheckCompatibility.services","lxErrorHandling.services","lxGlobalVarsAndConstants.services","lxHttp.services","lxPresence.services","lxVideoSetup.services","lxModalSupport.services","lxUtility.services","lxVideo.services","lxVideoNegotiation.services","scrollGlue.directives","presenceModule","ngAnimate","ngTouch","ui.bootstrap"]);videoApp.run(function(){}),angular.module("videoApp").config(["$provide",function(a){a.decorator("$log",["$delegate","errorLogService",function(a,b){var c={};return angular.extend(c,a),c.error=function(){a.error.apply(null,arguments),b.logErrorToServer.apply(null,arguments)},c}])}]),angular.module("lxUseChatRoom.controllers",[]).controller("lxChatViewCtrl",["$location","$scope","$timeout","lxHttpChannelService","lxChatRoomMembersService","lxShowNumMessagesService",function(a,b,c,d,e,f){b.lxMainViewCtrl.currentView="lxChatViewCtrl",b.videoStateInfoObject.enableShowVideoElements=!1,$(".cl-ng-view").one("animationend webkitAnimationEnd oAnimationEnd MSAnimationEnd",function(){b.$apply(function(){b.videoStateInfoObject.enableShowVideoElements=!0})});var g=function(a){var e=function(){b.channelObject.channelIsAlive?d.addClientToRoom(b.lxMainViewCtrl.clientId,b.lxMainViewCtrl.userId,a):c(e,100)};e()};e.createOrGetRoom().then(function(a){b.receivedChatMessageObject[a.chatRoomId]={},g(a.chatRoomId),a.chatRoomId in b.chatPanelDict&&f.subtractNumMessagesSeen(b.trackUnseenMessageCountObject,b.chatPanelDict[a.chatRoomId]),b.chatPanelDict[a.chatRoomId]={chatPanelIsGlued:!0,numMessagesSinceLastTimeBottomOfPanelWasViewed:0,chatPanelIsCurrentlyVisible:!0},b.chatRoomDisplayObject.chatPanelObject=b.chatPanelDict[a.chatRoomId],b.chatRoomDisplayObject.chatRoomId=a.chatRoomId,-1===$.inArray(a.normalizedChatRoomName,b.normalizedOpenRoomNamesList)&&b.normalizedOpenRoomNamesList.push(a.normalizedChatRoomName)},function(c){b.mainGlobalControllerObj.errorEnteringIntoRoomInfoObj=c,a.path("/")})}]).controller("lxMainVideoCtrl",["$log","$scope","lxAccessCameraAndMicrophoneService","lxCallService","lxCheckIfSystemSupportsWebRtcService","lxVideoService","lxVideoParamsService",function(a,b,c,d,e,f,g){b.accessCameraAndMicrophoneObject={modalsCurrentlyShown:[]},b.videoDisplaySelection={currentlySelectedVideoElementId:"localVideoElement"},b.showCameraAndMicrophoneInstructions=function(){e.checkBrowserVersionToSeeIfGetUserMediaSupported(b)&&c.showModalsAndArrowsForGrantingCameraAndMicrophoneAccess(b)},b.toggleWebcamMuteInterfaceFn=function(){d.toggleWebcamMute(b.localVideoObject)},b.toggleMicrophoneMuteInterfaceFn=function(){d.toggleMicrophoneMute(b.localVideoObject)},b.toggleAudioMuteInterfaceFn=function(a){d.toggleAudioMute(b.remoteVideoElementsDict[a])},b.myUsername=g.myUsername,b.showVideoElementsAndStartVideoFn=function(a,c){f.showVideoElementsAndStartVideoFn(b,a,c)}}]),angular.module("lxChatbox.controllers",[]).controller("lxChatPanelCtrl",["$anchorScroll","$location","$log","$scope","lxHttpChannelService","lxMessageService","lxShowNumMessagesService",function(a,b,c,d,e,f,g){d.inputMessageString="",d.sendMessageString="",d.sendMessageFailedString="",d.sendMessageStringTime=0,d.sendMessageTimeFailed=0,d.maxMsgLength=5e3,d.sendMessageFormScope={},d.sendMessagePayload={},d.removeClientFromRoomInterfaceFn=function(a){c.info("removeClientFromRoomInterfaceFn executing"),e.removeClientFromRoom(d.lxMainViewCtrl.clientId,d.lxMainViewCtrl.userId,a)},d.sendChatMessageFn=function(a){var b="chatTextMsg";d.sendMessagePayload={messageString:d.sendMessageFormScope.inputMessageString,messageUniqueId:(new Date).getTime(),transmittedToServer:null};var c=f.broadcastMessageToRoomFn(b,d.sendMessagePayload,d.lxMainViewCtrl.clientId,a);c.then(function(){d.sendMessageFormScope.inputMessageString="",d.sendMessagePayload.transmittedToServer=!0},function(){d.sendMessagePayload.transmittedToServer=!1,d.sendMessagePayload.messageString='<span class="cl-text-danger "><b>Server error. Message not delivered</b></span><br> '+d.sendMessageFormScope.inputMessageString,e.sendSynHeartbeatToServer(d.lxMainViewCtrl.clientId)})["finally"](function(){d.sendMessageTime=(new Date).getTime()})},d.gluePanel=function(){g.subtractNumMessagesSeen(d.trackUnseenMessageCountObject,d.chatPanelDict[d.roomOccupancyObject.chatRoomId]),d.chatPanelDict[d.roomOccupancyObject.chatRoomId].chatPanelIsGlued=!0},d.$watch(function(a){return a.chatPanelDict[a.roomOccupancyObject.chatRoomId].chatPanelIsGlued},function(a){a&&g.subtractNumMessagesSeen(d.trackUnseenMessageCountObject,d.chatPanelDict[d.roomOccupancyObject.chatRoomId])}),d.$watch("chatRoomDisplayObject.normalizedChatRoomNameFromUrl",function(){d.normalizedChatRoomName&&d.chatRoomDisplayObject&&d.normalizedChatRoomName===d.chatRoomDisplayObject.normalizedChatRoomNameFromUrl?(d.chatPanelDict[d.roomOccupancyObject.chatRoomId].chatPanelIsCurrentlyVisible=!0,d.chatRoomDisplayObject.chatPanelObject=d.chatPanelDict[d.roomOccupancyObject.chatRoomId],d.chatRoomDisplayObject.chatRoomId=d.roomOccupancyObject.chatRoomId,e.updateClientStatusOnServerAndRequestUpdatedRoomInfo(d.lxMainViewCtrl.clientId,d.presenceStatus,d.roomOccupancyObject.chatRoomId,"updateOnRoomChange")):d.chatPanelDict[d.roomOccupancyObject.chatRoomId].chatPanelIsCurrentlyVisible=!1})}]),angular.module("lxDebuggingInfo.controllers",[]).controller("lxDebuggingRemoteStreamController",function(){}),angular.module("lxLandingPage.controllers",["ngResource"]).controller("lxLandingPageCtrl",["$location","$log","$scope","lxLandingPageConstantsService","lxHttpHandleRoomService","lxAppWideConstantsService",function(a,b,c,d,e,f){angular.extend(d,lxLandingPageConstantsEmbeddedInHtml),c.lxMainViewCtrl.currentView="lxLandingPageCtrl",c.videoStateInfoObject.enableShowVideoElements=!1,c.chatboxPanelElementObject.videoIsFocused=!1,$(".cl-ng-view").one("animationend webkitAnimationEnd oAnimationEnd MSAnimationEnd",function(){c.$apply(function(){c.videoStateInfoObject.enableShowVideoElements=!0})});var g=new RegExp("["+d.chatRoomNameInvalidCharsForRegex+"]","g");c.validRoomNamesPattern=new RegExp("^[^"+d.chatRoomNameInvalidCharsForRegex+"]+$"),c.minInputLength=d.minRoomChars,c.maxInputLength=d.maxRoomChars,c.roomObj={},c.roomObj.userName=f.userName,c.goToRoomUrl=function(b){a.path("/"+b)},c.roomStatus={},c.showFormScope=function(){b.debug(c)},c.highlightInput=function(a){var b;return a.$invalid&&a.$dirty?b="cl-invalid-input-glow":a.$valid&&a.$dirty?(a.roomIsEmptyMessage&&(b="cl-valid-input-glow"),a.roomNotFullMessage&&(b="cl-warning-input-glow")):b="",b},c.$watch("createRoomForm.chatRoomNameInputElem.$viewValue",function(a){if(c.createRoomForm.chatRoomNameInputElem.$error.pattern){var b=[],d={},e=0,f=a.match(g);angular.forEach(f,function(a){if(!(a in d))if(d[a]="In",e++,a.match(/\s/)){var c="blank space";b.push(c)}else b.push(a)}),c.invalidCharacterFeedback=1===e?b[0]+" is not allowed in the chat room name":b.slice(0,b.length-1).join(",")+" and "+b.slice(-1)+" are not allowed in the chat room name"}})}]),angular.module("lxPresence.controllers",[]).controller("lxPresenceCtrl",["$log","$scope","presenceStatus",function(a,b,c){b.presenceStatus=c,c.onChange(function(c){b.text=c.name,a.log("onChange: "+c.name)}),c.ACTIVE.onEnter(function(){a.log("Entering ACTIVE")}),c.ACTIVE.onLeave(function(){a.log("Leaving ACTIVE")})}]),angular.module("lxMainView.controllers",[]).controller("lxVideoChatAppViewCtrl",["$document","$rootScope","$location","$log","$route","$scope","$window","$timeout","lxAppWideConstantsService","lxChannelService","clickAnywhereButHereService",function(a,b,c,d,e,f,g,h,i,j,k){function l(){k.temporarilyDisableHandleOuterClick()}angular.extend(i,userInfoEmbeddedInHtml),f.debugBuildEnabled=i.debugBuildEnabled,f.remoteVideoElementsDict={},b.chatRoomDisplayObject={chatRoomNameFromUrl:null,normalizedChatRoomNameFromUrl:null,lastChatRoomNameFromUrl:null,chatPanelObject:null,chatRoomId:null},f.roomOccupancyDict={},f.normalizedOpenRoomNamesList=[],f.simpleArrayOrderByFn=function(a){return a};var m=Math.floor(1e9*Math.random()),n=i.userId+"|"+m;f.lxMainViewCtrl={clientId:n,userId:i.userId,userName:i.userName,currentView:null},f.channelObject={channelToken:null,channelIsAlive:null,socket:null},f.localVideoObject={localMiniVideoElem:null,localBigVideoElem:null,isWebcamMuted:!1,isMicrophoneMuted:!1},f.notificationMenuObject={showNotificationMenu:!1,partialShowNotificationMenuAndGetAttention:!1},f.displayNotificationMenu=function(a,b){a.stopPropagation(),f.notificationMenuObject.showNotificationMenu=b,f.notificationMenuObject.showNotificationMenu&&(f.mainMenuObject.showMainMenu=!1),f.notificationMenuObject.partialShowNotificationMenuAndGetAttention=!1},f.toggleNotificationMenu=function(a){f.displayNotificationMenu(a,!f.notificationMenuObject.showNotificationMenu)},f.mainMenuObject={showMainMenu:!1},f.displayMainMenu=function(a,b){a.stopPropagation(),f.mainMenuObject.showMainMenu=b,f.mainMenuObject.showMainMenu&&(f.notificationMenuObject.showNotificationMenu=!1)},f.handleSwipeRight=function(a){l(),f.notificationMenuObject.showNotificationMenu||f.notificationMenuObject.partialShowNotificationMenuAndGetAttention?f.displayNotificationMenu(a,!1):f.displayMainMenu(a,!0)},f.handleSwipeLeft=function(a){l(),f.mainMenuObject.showMainMenu?f.displayMainMenu(a,!1):f.displayNotificationMenu(a,!0)},f.toggleMainMenu=function(a){f.displayMainMenu(a,!f.mainMenuObject.showMainMenu)},f.videoExchangeObjectsDict={},f.videoStateInfoObject={numOpenVideoExchanges:0,enableShowVideoElements:!0,numVideoRequestsPendingFromRemoteUsers:0,pendingRequestsForVideoSessionsList:[],currentOpenVideoSessionsList:[]},f.chatboxPanelElementObject={showFullChatHistory:!0,videoIsFocused:!0},f.videoSignalingObject={localUserAccessCameraAndMicrophoneStatus:"requestNotMade",debugShowAllVideoWindows:!1},f.receivedChatMessageObject={},f.chatPanelDict={},f.trackUnseenMessageCountObject={unseenMessageCount:0},f.mainGlobalControllerObj={errorEnteringIntoRoomInfoObj:null},f.dropdownMenusStatuses={groupMembersDropdownIsOpen:!0,openChatsDropdownIsOpen:!0},j.initializeChannel(f,n),b.$on("$routeChangeError",function(a,b,c,e){d.error("Error: $routeChangeError failure in lxMain.routes. "+e)}),b.$on("$locationChangeStart",function(a,b,c){d.debug("Next route: "+b),d.debug("Current route: "+c)}),b.$on("$locationChangeSuccess",function(){d.debug("$locationChangeSuccess called")}),b.$on("$routeChangeSuccess",function(){f.mainMenuObject.showMainMenu=!1;var a=e.current.params.chatRoomName;a?(b.chatRoomDisplayObject.chatRoomNameFromUrl=a,b.chatRoomDisplayObject.normalizedChatRoomNameFromUrl=a.toLowerCase(),b.chatRoomDisplayObject.lastChatRoomNameFromUrl=a):(b.chatRoomDisplayObject.chatRoomNameFromUrl=null,b.chatRoomDisplayObject.normalizedChatRoomNameFromUrl=null)})}]),angular.module("lxVideo.controllers",[]).controller("lxMainVideoWrapperCtrl",["$scope","lxPeerService","lxStreamService",function(a,b,c){a.$watch(function(){return!!b.remoteStream[a.videoDisplaySelection.currentlySelectedVideoElementId]},function(b){a.remoteStreamIsActive=b}),a.$watch(c.getLocalStreamBoolean,function(b){a.localStreamIsActive=b})}]).controller("lxMiniVideoRepeatWrapper",["$scope",function(a){function b(){for(var b=3,c=["localVideoElement"].concat(a.videoStateInfoObject.currentOpenVideoSessionsList),d=[],e=0;e<c.length;e+=b){for(var f=[],g=0;b>g;g++){var h=e+g;if(void 0===c[h])break;f.push(c[h])}d.push(f)}a.miniVideoElementsWrappedForRepeat=d}a.$watch(function(){return a.videoStateInfoObject.currentOpenVideoSessionsList.length},b)}]);var lxMainRoutes=angular.module("lxMain.routes",["ngRoute"]);lxMainRoutes.config(["$routeProvider","$locationProvider",function(a,b){b.html5Mode(!0),a.when("/",{templateUrl:function(){return"/_lx/lx-templates/lx-landing-page-main.html"},controller:"lxLandingPageCtrl"}),a.when("/:chatRoomName",{templateUrl:function(){return"/_lx/lx-templates/lx-dummy-chatbox-view.html"},controller:"lxChatViewCtrl"}),a.otherwise({redirectTo:"/"})}]),angular.module("lxAccessSystemResources.services",[]).factory("lxAccessCameraAndMicrophoneService",["$timeout","$animate","$log","$modalStack","lxVideoParamsService","lxCallService","lxMediaService","lxCheckCompatibilityService","lxModalSupportService",function(a,b,c,d,e,f,g,h,i){var j=null,k=null,l=null,m=null,n=function(a,b){e.mediaConstraints.audio===!1&&e.mediaConstraints.video===!1?f.hasAudioOrVideoMediaConstraints=!1:(f.hasAudioOrVideoMediaConstraints=!0,g.doGetUserMedia(a,b))},o=function(b,d){var e="",f=0,g=null;if("mozilla"===$.browser.name&&$.browser.desktop&&"waitingForResponse"===d.localUserAccessCameraAndMicrophoneStatus&&(e="cl-arrow-mozilla"),"opera"===$.browser.name&&$.browser.desktop&&"denyAccess"===d.localUserAccessCameraAndMicrophoneStatus&&(e="cl-arrow-opera"),""!==e){if(g=angular.element('<div class="cl-arrow"><span class="icon-lx-arrow-up"></span></div>'),$("body").append(g),g.addClass(e),"allowAccess"!==d.localUserAccessCameraAndMicrophoneStatus){j&&(c.debug("removing old arrow timer"),a.cancel(j),j=null),c.debug("starting arrow timer");var h=function(){j=a(function(){g.hasClass("cl-show-arrow")?(g.removeClass("cl-show-arrow"),f=3e3):(g.addClass("cl-show-arrow"),f=15e3),h()},f)};h()}}else u(g);return g},p=function(a,b,d,e){i.closeModal(k),c.log("showing modal for "+b),k=i.showCameraAndMicrophoneModal(a,b,d,e)},q=function(a,b){var c="",d="";"denyAccess"===b?$.browser.desktop?(c="cl-modal-override-position-lower",p(a,"lx-template-cache/chrome-desktop-and-mac-access-camera-previously-denied-modal.html",c,d)):p(a,"lx-template-cache/chrome-mobile-access-camera-previously-denied-modal.html",c,d):"waitingForResponse"===b&&("mac"===$.browser.platform?(c="cl-modal-override-position-lower",p(a,"lx-template-cache/chrome-mac-access-camera-modal.html",c,d)):$.browser.desktop?(c="cl-modal-override-position-lower",p(a,"lx-template-cache/chrome-desktop-access-camera-modal.html",c,d)):p(a,"lx-template-cache/chrome-mobile-access-camera-modal.html",c,d))},r=function(a,b){var d="",e="";c.log("mozilla cameraAccessStatus is "+b),"denyAccess"===b?$.browser.desktop?p(a,"lx-template-cache/mozilla-desktop-access-camera-previously-denied-modal.html",d,e):p(a,"lx-template-cache/mozilla-mobile-access-camera-previously-denied-modal.html",d,e):"waitingForResponse"===b&&$.browser.desktop&&(d="cl-modal-override-position-lower",p(a,"lx-template-cache/mozilla-desktop-access-camera-modal.html",d,e))},s=function(a,b){var c="",d="";"denyAccess"===b?(c="cl-modal-override-position-lower",$.browser.desktop?p(a,"lx-template-cache/opera-desktop-access-camera-previously-denied-modal.html",c,d):p(a,"lx-template-cache/opera-mobile-access-camera-previously-denied-modal.html",c,d)):"waitingForResponse"===b&&$.browser.desktop},t=function(a,b){var c=b.localUserAccessCameraAndMicrophoneStatus;"chrome"===$.browser.name&&q(a,c),"mozilla"===$.browser.name&&r(a,c),"opera"===$.browser.name&&s(a,c)},u=function(b){c.log("removing arrow and watchers"),null!==b&&b.remove(),j&&(c.debug("canceling old arrow timer"),a.cancel(j),j=null)},v=function(){l&&l(),m&&m()},w=function(a){return function(){var b=a.accessCameraAndMicrophoneObject.modalsCurrentlyShown,c=b.length;return c>0?b[c-1]:null}},x=function(a){return function(){return a.videoSignalingObject.localUserAccessCameraAndMicrophoneStatus}};return{showModalsAndArrowsForGrantingCameraAndMicrophoneAccess:function(a){var b=a.videoSignalingObject;if(v(),h.userDeviceBrowserAndVersionSupported){var d=null;n(a),m=a.$watch(w(a),function(e){null!==e?(c.log("showing arrow pointing to accept button. whichModalIsOpen is: "+e),d=o(a,b)):u(d)}),l=a.$watch(x(a),function(e,f){c.info("cameraStatus is: "+e+" previousCameraStatus: "+f),u(d),"allowAccess"===b.localUserAccessCameraAndMicrophoneStatus?(v(),i.closeModal(k)):t(a,b)})}}}}]).factory("lxCheckIfSystemSupportsWebRtcService",["$templateCache","$modal","$log","lxCheckCompatibilityService","lxModalSupportService",function(a,b,c,d,e){return{checkBrowserVersionToSeeIfGetUserMediaSupported:function(){var a=!0;return d.isIosDevice?(e.showStandardModalWindowFromTemplateUrl("lx-template-cache/ios-is-not-supported-modal.html"),a=!1):d.isSupportedBrowser?d.browserVersionIsSupported||(e.showStandardModalWindowFromTemplateUrl("lx-template-cache/browser-version-is-not-supported-modal.html"),a=!1):(e.showStandardModalWindowFromTemplateUrl("lx-template-cache/browser-is-not-supported-modal.html"),a=!1),a}}}]),angular.module("lxBasicFunctionality.services",[]).factory("lxJs",function(){return{assert:function(a,b){if(!a){if(b=b||"Assertion failed","undefined"!=typeof Error)throw new Error(b);throw b}}}}),angular.module("lxVideo.services",[]).factory("lxVideoService",["$log","lxAccessVideoElementsAndAccessCameraService","lxCallService","lxCreateChatRoomObjectsService","lxJs",function(a,b,c,d,e){function f(a,b){if(!a.localVideoObject.localMiniVideoElem){var c=angular.element('<video class="cl-video cl-mini-video-sizing" autoplay="autoplay" muted="true"></video>');a.localVideoObject.localMiniVideoElem=c[0]}b in a.remoteVideoElementsDict||(c=angular.element('<video class="cl-video cl-mini-video-sizing" autoplay="autoplay"></video>'),a.remoteVideoElementsDict[b]=d.createRemoteVideoElementsObject(c[0]))}return{showVideoElementsAndStartVideoFn:function(g,h,i){f(g,i),e.assert(i,"remoteClientId is not set"),i in g.videoExchangeObjectsDict||(a.info("showVideoElementsAndStartVideoFn creating new videoExchangeObjectsDict entry for remote client "+i),g.videoExchangeObjectsDict[i]=d.createVideoExchangeSettingsObject()),g.videoExchangeObjectsDict[i].localVideoEnabledSetting=h;var j=g.videoStateInfoObject.currentOpenVideoSessionsList.indexOf(i);-1===j&&(g.videoStateInfoObject.currentOpenVideoSessionsList.unshift(i),g.videoDisplaySelection.currentlySelectedVideoElementId=i);var k=g.videoStateInfoObject.pendingRequestsForVideoSessionsList.indexOf(i);
k>=0&&g.videoStateInfoObject.pendingRequestsForVideoSessionsList.splice(k,1),b.sendStatusOfVideoElementsEnabled(g,h,i);var l=g.videoExchangeObjectsDict[i].remoteVideoEnabledSetting;if("doVideoExchange"===h&&("hangupVideoExchange"===l||"denyVideoExchange"===l)&&(g.videoExchangeObjectsDict[i].remoteVideoEnabledSetting="waitingForPermissionToEnableVideoExchange"),"hangupVideoExchange"===h||"denyVideoExchange"===h){j=g.videoStateInfoObject.currentOpenVideoSessionsList.indexOf(i),g.videoStateInfoObject.currentOpenVideoSessionsList.splice(j,1),g.videoDisplaySelection.currentlySelectedVideoElementId="localVideoElement";var m=g.videoStateInfoObject.currentOpenVideoSessionsList.length;c.doHangup(i,m),delete g.remoteVideoElementsDict[i],delete g.videoExchangeObjectsDict[i]}g.videoStateInfoObject.numOpenVideoExchanges=g.videoStateInfoObject.currentOpenVideoSessionsList.length,g.videoStateInfoObject.numVideoRequestsPendingFromRemoteUsers=g.videoStateInfoObject.pendingRequestsForVideoSessionsList.length}}}]),angular.module("lxChannel.services",[]).service("lxChannelMessageService",function(){function a(a){a in b||(b[a]=[])}var b={};return{clearQueue:function(c){a(c),b[c].length=0},unshift:function(c,d){return a(c),b[c].unshift(d)},push:function(c,d){return a(c),b[c].push(d)},shift:function(c){return a(c),b[c].shift()},getQueueLength:function(c){return a(c),b[c].length}}}).factory("lxChannelService",["$log","$timeout","$rootScope","$window","lxAccessVideoElementsAndAccessCameraService","lxAppWideConstantsService","lxCallService","lxChannelMessageService","lxCreateChatRoomObjectsService","lxHttpChannelService","lxJavascriptConstants","lxJs","lxMessageService","lxWebRtcSessionService",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n){var o=null,p=null,q=function(d){return function(e){var f=d.localVideoObject;c.$apply(function(){var c,k=JSON.parse(e.data),m=k.fromClientId,o=d.remoteVideoElementsDict[m],q=null;switch(l.assert(m,"remoteClientId is not set"),k.messageType){case"sdp":var r=k.messagePayload;d.videoExchangeObjectsDict[m]&&d.videoExchangeObjectsDict[m].rtcInitiator||n.webRtcSessionStarted[m]?n.processSignalingMessage(r,f,o,d.lxMainViewCtrl.clientId,m):"offer"===r.type?(h.unshift(m,r),n.signalingReady[m]=!0,a.debug("lxWebRtcSessionService.signalingReady = true"),g.maybeStart(d,m)):h.push(m,r);break;case"roomOccupancyMsg":var s=k.messagePayload.normalizedChatRoomName,t=k.messagePayload.chatRoomNameAsWritten;q=k.messagePayload.chatRoomId;var u=d.roomOccupancyDict;u[s]={},u[s].chatRoomNameAsWritten=t,u[s].chatRoomId=q,a.debug("Room status received: "+JSON.stringify(k.messagePayload)),u[s].dictOfClientObjects=k.messagePayload.dictOfClientObjects,u[s].listOfClientObjects=[],angular.forEach(u[s].dictOfClientObjects,function(a,b){a.clientId=b,u[s].listOfClientObjects.push(a)});break;case"roomInitialVideoSettingsMsg":"rtcInitiator"in k.messagePayload&&(n.stop(m),d.videoExchangeObjectsDict[m].rtcInitiator=k.messagePayload.rtcInitiator,n.signalingReady[m]=k.messagePayload.rtcInitiator,n.webRtcSessionStarted[m]=!1,g.maybeStart(d,m));break;case"chatTextMsg":q=k.chatRoomId,c=d.receivedChatMessageObject[q],c.messageString=k.messagePayload.messageString,c.receivedMessageTime=(new Date).getTime();break;case"clientReAddedToRoomAfterAbsence":q=k.chatRoomId,c=d.receivedChatMessageObject[q],c.messageString="**** WARNING *** Due to connectivity problems, you may have missed some messages",c.receivedMessageTime=(new Date).getTime();break;case"synAckHeartBeat":l.assert(m===d.lxMainViewCtrl.clientId,"clientId mismatch"),a.log("Received heartbeat syn acknowledgement: "+JSON.stringify(k)),d.channelObject.channelIsAlive=!0,b.cancel(p),j.sendAckHeartbeatToServer(d.lxMainViewCtrl.clientId,d.presenceStatus,d.chatRoomDisplayObject.chatRoomId);break;case"videoExchangeStatusMsg":m in d.videoExchangeObjectsDict||(a.info("videoExchangeStatusMsg causing creation of new videoExchangeObjectsDict entry for client "+m),d.videoExchangeObjectsDict[m]=i.createVideoExchangeSettingsObject());var v=k.messagePayload.videoElementsEnabledAndCameraAccessRequested;if(d.videoExchangeObjectsDict[m].remoteVideoEnabledSetting=v,"hangupVideoExchange"===v&&(n.stop(m),"waitingForPermissionToEnableVideoExchange"===d.videoExchangeObjectsDict[m].localVideoEnabledSetting&&delete d.videoExchangeObjectsDict[m]),"doVideoExchange"===v&&-1===d.videoStateInfoObject.currentOpenVideoSessionsList.indexOf(m)&&d.videoStateInfoObject.pendingRequestsForVideoSessionsList.indexOf(-1===m)&&d.videoStateInfoObject.pendingRequestsForVideoSessionsList.push(m),"doVideoExchange"!==v){var w=d.videoStateInfoObject.pendingRequestsForVideoSessionsList.indexOf(m);w>=0&&d.videoStateInfoObject.pendingRequestsForVideoSessionsList.splice(w,1)}d.videoStateInfoObject.numVideoRequestsPendingFromRemoteUsers=d.videoStateInfoObject.pendingRequestsForVideoSessionsList.length,d.videoStateInfoObject.numOpenVideoExchanges=d.videoStateInfoObject.currentOpenVideoSessionsList.length;break;default:a.error("Error: Unkonwn messageType received on Channel: "+JSON.stringify(k))}})}},r=function(b){return function(){a.log("Channel opened."),b.channelObject.channelIsAlive=!0,x(b)}},s=function(b){return function(){a.error("*** Channel error. ***"),b.channelObject.channelIsAlive=!1}},t=function(b){return function(){a.warn("*** Channel closed. ***"),b.channelObject.channelIsAlive=!1}},u=function(a){return{onopen:r(a),onmessage:q(a),onerror:s(a),onclose:t(a)}},v=function(b){a.info("*** Opening channel. ***");try{var c=new goog.appengine.Channel(b.channelObject.channelToken);b.channelObject.socket=c.open(u(b))}catch(d){d.message="\n	Error in openChannel\n	"+d.message,a.error(d),b.channelObject.channelIsAlive=!1}},w=function(){b.cancel(o),o=null},x=function(a){w(),j.sendSynHeartbeatToServer(a.lxMainViewCtrl.clientId);var c=function(){o=b(function(){j.sendSynHeartbeatToServer(a.lxMainViewCtrl.clientId),c(),p=b(function(){y(a)},k.msToWaitForHeartbeatResponse)},f.heartbeatIntervalMilliseconds)};c()},y=function(b){a.error("Heartbeat not received within "+k.msToWaitForHeartbeatResponse+" ms. Re-initializing channel."),z.initializeChannel(b)},z={initializeChannel:function(b){j.requestChannelToken(b.lxMainViewCtrl.clientId,f.userId).then(function(c){b.channelObject.channelToken=c.data.channelToken,v(b),d.onbeforeunload=function(){a.debug("Manually disconnecting channel on window unload event."),j.manuallyDisconnectChannel(b.lxMainViewCtrl.clientId,b.channelObject)}},function(){b.channelObject.channelToken="Failed to get channelToken",b.channelObject.channelIsAlive=!1})}};return z}]),angular.module("lxChatbox.services",[]),angular.module("lxCheckCompatibility.services",[]).factory("lxCheckCompatibilityService",function(){function a(){var a=28,b=30,c=20;return $.browser.mozilla&&$.browser.versionNumber<a||$.browser.chrome&&$.browser.versionNumber<b||$.browser.opera&&$.browser.versionNumber<c?!1:!0}var b=$.browser.ipad||$.browser.iphone,c=$.browser.mozilla||$.browser.chrome||$.browser.opera,d=a(),e=!b&&c&&d;return{isIosDevice:b,isSupportedBrowser:c,browserVersionIsSupported:d,userDeviceBrowserAndVersionSupported:e}}),angular.module("lxCodecs.services",[]).factory("lxCodecsService",["$log","lxVideoParamsService",function(a,b){function c(a,b,c){return d(a,0,-1,b,c)}function d(a,b,c,d,e){for(var f=-1!==c?c:a.length,g=b;f>g;++g)if(0===a[g].indexOf(d)&&(!e||-1!==a[g].toLowerCase().indexOf(e.toLowerCase())))return g;return null}function e(a){var b=new RegExp("a=rtpmap:(\\d+) \\w+\\/\\d+"),c=a.match(b);return c&&2===c.length?c[1]:null}var f=function(a,b){for(var c=a[b].split(" "),d=a.length-1;d>=0;d--){var e=g(a[d],/a=rtpmap:(\d+) CN\/\d+/i);if(e){var f=c.indexOf(e);-1!==f&&c.splice(f,1),a.splice(d,1)}}return a[b]=c.join(" "),a},g=function(a,b){var c=a.match(b);return c&&2===c.length?c[1]:null},h=function(a,b){for(var c=a.split(" "),d=[],e=0,f=0;f<c.length;f++)3===e&&(d[e++]=b),c[f]!==b&&(d[e++]=c[f]);return d.join(" ")},i=function(b,c){var d=c.split("/");if(2!==d.length)return a.log("Invalid codec setting: "+c),b;var e,i=d[0],j=d[1],k=b.split("\r\n"),l=null;for(e=0;e<k.length;e++)if(-1!==k[e].search("m=audio")){l=e;break}if(null===l)return b;for(e=0;e<k.length;e++)if(-1!==k[e].search(i+"/"+j)){var m=new RegExp(":(\\d+) "+i+"\\/"+j,"i"),n=g(k[e],m);n&&(k[l]=h(k[l],n));break}return k=f(k,l),b=k.join("\r\n")},j=function(b,e,f){var g=b.split("\r\n"),h=c(g,"m=",f);if(null===h)return a.error("Failed to add bandwidth line to sdp, as no m-line found"),b;var i=d(g,h+1,-1,"m=");null===i&&(i=g.length);var j=d(g,h+1,i,"c=");if(null===j)return a.error("Failed to add bandwidth line to sdp, as no c-line found"),b;var k=d(g,j+1,i,"b=AS");k&&g.splice(k,1);var l="b=AS:"+e;return g.splice(j+1,0,l),b=g.join("\r\n")};return{maybeSetVideoSendInitialBitRate:function(d){if(!b.videoSendInitialBitrate)return d;var f=b.videoSendInitialBitrate;b.videoSendBitrate&&(b.videoSendInitialBitrate>b.videoSendBitrate&&(a.error("Clamping initial bitrate to max bitrate of "+b.videoSendBitrate+" kbps."),b.videoSendInitialBitrate=b.videoSendBitrate),f=b.videoSendBitrate);var g=d.split("\r\n"),h=c(g,"m=","video");if(null===h)return a.error("Failed to find video m-line"),d;var i=c(g,"a=rtpmap","VP8/90000"),j=e(g[i]),k="a=fmtp:"+j+" x-google-min-bitrate="+b.videoSendInitialBitrate.toString()+"; x-google-max-bitrate="+f.toString();return g.splice(i+1,0,k),g.join("\r\n")},maybeSetAudioSendBitRate:function(c){return b.audioSendBitrate?(a.log("Prefer audio send bitrate: "+b.audioSendBitrate),j(c,b.audioSendBitrate,"audio")):c},maybeSetAudioReceiveBitRate:function(c){return b.audioRecvBitrate?(a.log("Prefer audio receive bitrate: "+b.audioRecvBitrate),j(c,b.audioRecvBitrate,"audio")):c},maybeSetVideoSendBitRate:function(c){return b.videoSendBitrate?(a.log("Prefer video send bitrate: "+b.videoSendBitrate),j(c,b.videoSendBitrate,"video")):c},maybeSetVideoReceiveBitRate:function(c){return b.videoRecvBitrate?(a.log("Prefer video receive bitrate: "+b.videoRecvBitrate),j(c,b.videoRecvBitrate,"video")):c},maybePreferAudioSendCodec:function(c){return""===b.audioSendCodec?(a.log("No preference on audio send codec."),c):(a.log("Prefer audio send codec: "+b.audioSendCodec),i(c,b.audioSendCodec))},maybePreferAudioReceiveCodec:function(c){return""===b.audioReceiveCodec?(a.log("No preference on audio receive codec."),c):(a.log("Prefer audio receive codec: "+b.audioReceiveCodec),i(c,b.audioReceiveCodec))},addStereo:function(a){var b,c=a.split("\r\n"),d=null;for(b=0;b<c.length;b++)if(-1!==c[b].search("opus/48000")){d=g(c[b],/:(\d+) opus\/48000/i);break}var e=null;for(b=0;b<c.length;b++)if(-1!==c[b].search("a=fmtp")){var f=g(c[b],/a=fmtp:(\d+)/);if(f===d){e=b;break}}return null===e?a:(c[e]=c[e].concat(" stereo=1"),a=c.join("\r\n"))}}}]),angular.module("lxUtility.services",[]).factory("lxDelayActionService",function(){return{getDelayFn:function(){var a=null;return function(b,c){clearTimeout(a),a=setTimeout(b,c)}}}}).factory("lxTimeService",function(){function a(a,b){for(a=a.toString();a.length<b;)a="0"+a;return a}return{getTimeString:function(){var b=new Date,c=b.getHours(),d=b.getMinutes(),e=b.getSeconds();d=a(d,2),e=a(e,2);var f=c+":"+d+":"+e;return f}}}).factory("lxSoundService",function(){var a=!1;return function(){var b=document.createElement("audio");b.canPlayType&&b.canPlayType("audio/mpeg")&&(a=!0)}(),{canPlayMp3:a}}).factory("lxWindowFocus",function(){function a(){return b}var b=!0;return $(window).focus(function(){b=!0}).blur(function(){b=!1}),{windowIsFocusedFn:a}}).factory("lxShowNumMessagesService",["$timeout","lxWindowFocus",function(a,b){var c=!0,d=null,e=function(a,b){a.unseenMessageCount-=b.numMessagesSinceLastTimeBottomOfPanelWasViewed,b.numMessagesSinceLastTimeBottomOfPanelWasViewed=0},f={subtractNumMessagesSeen:function(a,b){e(a,b),f.showNumMessagesInDocumentTitle(a)},stopFlashingTitle:function(){a.cancel(d),d=null},showNumMessagesInDocumentTitle:function(e){if(e.unseenMessageCount){if(document.title="("+e.unseenMessageCount+") "+$("#id-document-title-div").text(),b.windowIsFocusedFn())f.stopFlashingTitle();else if(!d){var g=2e3,h=function(){d=a(function(){e.unseenMessageCount&&(document.title=c?$("#id-document-title-div").text():"("+e.unseenMessageCount+") "+$("#id-document-title-div").text()),c=!c,g=500,h()},g)};h()}}else document.title=$("#id-document-title-div").text()}};return f}]);var lxErrorHandlingServices=angular.module("lxErrorHandling.services",[]);lxErrorHandlingServices.factory("errorLogService",["$window",function(a){function b(a,b){$.ajax({type:"POST",url:a,contentType:"application/json",data:b})}return{logErrorToServer:function(c,d){var e,f="/_lx/log_error";try{var g=$.browser;e=angular.toJson(c.message?{errorMessage:c.message,errorUrl:a.location.href,stackTrace:c.stack,extraInfo:d,browserInfo:g}:{errorMessage:c,errorUrl:a.location.href,browserInfo:g}),b(f,e)}catch(h){console.log("Error in logErrorToServer: "+h.message);try{e=angular.toJson({errorMessage:"Serious error!!! logErrorToServer has an internal error."}),b(f,e)}catch(h){console.log("Error in the error handler!!!")}}}}}]),angular.module("lxHttp.services",[]).factory("lxHttpHandleRoomService",["$log","$http",function(a,b){return{createOrGetRoomOnServer:function(a){var c="/_lx/create_new_room_if_does_not_exist/",d=b.post(c,a);return d},checkIfRoomExists:function(a){var c=null;if(a){var d="/_lx/check_if_chat_room_exists/"+a;c=b.get(d)}return c}}}]).factory("lxHttpChannelService",["$log","$http","lxJs",function(a,b,c){var d={sendSynHeartbeatToServer:function(a){var c={},d={clientId:a,messageType:"synHeartBeat",messagePayload:c};b.post("/_lx/channel/syn_user_heartbeat/",d)},updateClientStatusOnServerAndRequestUpdatedRoomInfo:function(a,c,d,e){var f={presenceStateName:c.getCurrent().name,currentlyOpenChatRoomId:d},g={clientId:a,messageType:e,messagePayload:f};b.post("/_lx/channel/update_client_status_and_request_updated_room_info/",g)},sendAckHeartbeatToServer:function(a,b,c){d.updateClientStatusOnServerAndRequestUpdatedRoomInfo(a,b,c,"ackHeartbeat")},addClientToRoom:function(a,d,e){c.assert(a,"clientId not set"),c.assert(d,"userId not set"),c.assert(e,"chatRoomId not set");var f={clientId:a,userId:d,chatRoomId:e};b.post("/_lx/add_client_to_room/",f)},removeClientFromRoom:function(a,c,d){var e={clientId:a,userId:c,chatRoomId:d};b.post("/_lx/remove_client_from_room/",e)},requestChannelToken:function(c,d){var e={clientId:c,userId:d},f=b.post("/_lx/channel/request_channel_token/",e);return f.then(function(b){a.info("Got channel data: "+b.data)},function(b){a.error("Failed to open channel for client id: "+c+"\nStatus: "+b.statusText+"\ndata: "+angular.toJson(b.data))}),f},manuallyDisconnectChannel:function(c,d){b.post("/_lx/channel/manual_disconnect/","from="+c,{headers:{"Content-Type":"application/x-www-form-urlencoded;"}}).success(function(){a.info("Successfully send manual disconnect to server for clientId: "+c)}).error(function(){a.warn("Failed to send manual disconnect to server for clientId: "+c)}),d.socket.close()}};return d}]).factory("lxMessageService",["$http","$log","lxChatRoomVarsService","lxJs",function(a,b,c,d){return{broadcastMessageToRoomFn:function(b,c,e,f){d.assert(e,"fromClientId is not set"),d.assert(f,"chatRoomId is not set");var g={chatRoomId:f,fromClientId:e,messageType:b,messagePayload:c},h="/_lx/message_room",i=a.post(h,g);return i},sendMessageToClientFn:function(b,c,e,f){d.assert(f,"toClientId is not set"),d.assert(e,"fromClientId is not set");var g={fromClientId:e,toClientId:f,messageType:b,messagePayload:c},h="/_lx/message_client",i=a.post(h,g);return i}}}]),angular.module("lxGlobalVarsAndConstants.services",[]).factory("lxJavascriptConstants",function(){var a={msToWaitForHeartbeatResponse:7500};return a}).factory("lxChatRoomVarsService",function(){var a={sdpConstraints:{mandatory:{OfferToReceiveAudio:!0,OfferToReceiveVideo:!0}}};return a}).factory("lxVideoParamsService",function(){function a(){var a="";return $.browser.chrome&&$.browser.android&&(a="ISAC/16000"),a}function b(){return"stun.l.google.com:19302"}function c(a,c,d){var e=b(),f={},g=[];if(e){var h="stun:"+e;g.push({urls:h})}if(a){var i="turn:"+a;g.push({urls:i,credential:c})}return f.iceServers=g,d&&(f.iceTransports=d),f}function d(){var a={optional:[]};return a.optional.push({googImprovedWifiBwe:!0}),a}var e=null,f=null,g=null;return{audioReceiveCodec:"opus/48000",audioSendCodec:a(),offerConstraints:{mandatory:{},optional:[]},pcConfig:c(e,f,g),pcConstraints:d(),mediaConstraints:{video:{mandatory:{},optional:[]},audio:{mandatory:{},optional:[]}},videoSendInitialBitrate:"",audioRecvBitrate:"",audioSendBitrate:"",videoRecvBitrate:"",videoSendBitrate:"",stereoscopic:"",stereo:!1}}).factory("lxAppWideConstantsService",function(){return{}}).factory("lxAppWideVarsService",function(){return{}}).factory("lxLandingPageConstantsService",function(){return{}});var lxModalSupportServices=angular.module("lxModalSupport.services",[]);lxModalSupportServices.controller("modalInstanceCtrl",["$scope","$log","$modalInstance",function(a,b,c){a.modalOkFn=function(){c.close()},a.modalCancelFn=function(){c.close()}}]),lxModalSupportServices.service("lxModalSupportService",["$modal","$log","$timeout",function(a,b,c){this.showCameraAndMicrophoneModal=function(d,e,f,g){var h=a.open({templateUrl:e,controller:"modalInstanceCtrl",windowClass:f,size:g});return h.opened.then(function(){b.log("Added modal box to modalsCurrentlyShown: "+e),d.accessCameraAndMicrophoneObject.modalsCurrentlyShown.push(e)},function(){}),h.result.then(function(){},function(){})["finally"](function(){c(function(){var a=d.accessCameraAndMicrophoneObject.modalsCurrentlyShown;a.splice(a.indexOf(e),1),b.log("Removed modal box from modalsCurrentlyShown: "+e)})}),h},this.closeModal=function(a){if(null!==a){b.info("closing most recent modal");try{a.close()}catch(c){c instanceof TypeError?b.warn(c.message):(c.message="\n	Error in closeModal\n	"+c.message,b.error(c))}}},this.showStandardModalWindowFromTemplateUrl=function(c){var d=a.open({templateUrl:c,controller:"modalInstanceCtrl"});d.result.then(function(){b.log("modal closed "+c)},function(){b.log("modal dismissed "+c)})["finally"](function(){b.log("Closed the modal box for "+c)})},this.showStandardModalWindowFromTemplate=function(c){var d=a.open({template:c,controller:"modalInstanceCtrl"});d.result.then(function(){b.log("modal closed "+c)},function(){b.log("modal dismissed "+c)})["finally"](function(){b.log("Closed the modal box for "+c)})}}]),angular.module("lxPresence.services",["presenceModule"]).factory("presenceStatus",["$presence",function(a){return a.init({ACTIVE:{enter:0,initial:!0},IDLE:{enter:3e4},AWAY:{enter:3e5}})}]),angular.module("lxChatRoom.services",[]).factory("lxChatRoomMembersService",["$log","$location","$routeParams","$window","$q","lxChannelService","lxHttpChannelService","lxHttpHandleRoomService","lxAppWideConstantsService",function(a,b,c,d,e,f,g,h,i){var j=function(a,c,d,e){var f={statusString:d,pageNameThatCausedError:c,pageUrlThatCausedError:b.path()};e.reject(f),a(f)};return{createOrGetRoom:function(){var b=c.chatRoomName,d=e.defer();a.log("addUserToRoom called: "+b+". Adding userId: "+i.userId);var f={};return f.chatRoomNameAsWritten=b,f.userId=i.userId,h.createOrGetRoomOnServer(f).then(function(b){"roomJoined"===b.data.statusString?d.resolve(b.data):j(a.warn,f.chatRoomNameAsWritten,b.data.statusString,d)},function(b){j(a.error,f.chatRoomNameAsWritten,b.data.statusString,d)}),d.promise}}}]).factory("lxCreateChatRoomObjectsService",function(){return{createVideoExchangeSettingsObject:function(){return{localVideoEnabledSetting:"waitingForPermissionToEnableVideoExchange",remoteVideoEnabledSetting:"waitingForPermissionToEnableVideoExchange",rtcInitiator:!1}},createRemoteVideoElementsObject:function(a){return{remoteMiniVideoElem:a,isAudioMuted:!1}}}});var webRtcServices=angular.module("lxVideoSetup.services",[]);webRtcServices.service("lxAdapterService",["$log",function(a){try{this.webrtcDetectedBrowser=webrtcDetectedBrowser,webrtcDetectedBrowser?(this.createIceServers=window.createIceServers,this.RTCPeerConnection=RTCPeerConnection,this.RTCSessionDescription=RTCSessionDescription,this.getUserMedia=getUserMedia,this.attachMediaStream=attachMediaStream,this.reattachMediaStream=reattachMediaStream,this.RTCIceCandidate=RTCIceCandidate):this.reattachMediaStream=function(){a.warn("reattachMediaStream called on an unsupported browser")}}catch(b){b.message="\n	Error in lxAdapterService\n	"+b.message,a.error(b)}}]),webRtcServices.service("lxTurnSupportService",function(){this.turnDone=!1}),webRtcServices.factory("lxTurnService",["$log","$http","lxAdapterService","lxAppWideConstantsService","lxCallService","lxCheckCompatibilityService","lxPeerService","lxTurnSupportService","lxVideoParamsService",function(a,b,c,d,e,f,g,h,i){var j=function(b){try{var d=b.data,e=c.createIceServers(d.uris,d.username,d.password);null!==e&&(i.pcConfig.iceServers=i.pcConfig.iceServers.concat(e)),a.log("Got pcConfig.iceServers:"+i.pcConfig.iceServers+"\n")}catch(f){f.message="\n	Error in onTurnResult\n	"+f.message,a.error(f)}},k=function(){a.error("No TURN server; unlikely that media will traverse networks.")},l=function(){return function(){h.turnDone=!0}};return{maybeRequestTurn:function(){if(f.userDeviceBrowserAndVersionSupported){for(var c="https://computeengineondemand.appspot.com/turn?username="+d.userName+"&key=4080218913",e=0,g=i.pcConfig.iceServers.length;g>e;e++)if("turn:"===i.pcConfig.iceServers[e].urls.substr(0,5))return void(h.turnDone=!0);var m=document.domain;if(-1===m.search("localhost")&&-1===m.search("apprtc"))return void(h.turnDone=!0);b.get(c).then(j,k).then(l())}else a.warn("This browser does not support WebRTC - we cannot setup a video connection")}}}]),webRtcServices.service("lxIceService",["$log","lxMessageService",function(a,b){var c={Local:{},Remote:{}},d=this,e=function(){};this.iceCandidateType=function(a){return a.indexOf("typ relay ")>=0?"TURN":a.indexOf("typ srflx ")>=0?"STUN":a.indexOf("typ host ")>=0?"HOST":"UNKNOWN"},this.noteIceCandidate=function(a,b){c[a][b]||(c[a][b]=1,e())},this.onIceCandidate=function(c,e){return function(f){f.candidate?(b.sendMessageToClientFn("sdp",{type:"candidate",label:f.candidate.sdpMLineIndex,id:f.candidate.sdpMid,candidate:f.candidate.candidate},c,e),d.noteIceCandidate("Local",d.iceCandidateType(f.candidate.candidate))):a.log("End of candidates.")}},this.onAddIceCandidateSuccess=function(){a.log("AddIceCandidate success.")},this.onAddIceCandidateError=function(b){a.error("Failed to add Ice Candidate: "+angular.toJson(b))}}]),webRtcServices.factory("lxSessionDescriptionService",["$log","$timeout","lxAdapterService","lxCodecsService","lxMessageService","lxPeerService","lxChatRoomVarsService","lxVideoParamsService",function(a,b,c,d,e,f,g,h){var i=function(){a.log("Set session description success.")},j=function(a,b){var c=a;for(var d in b.mandatory)c.mandatory[d]=b.mandatory[d];return c.optional.concat(b.optional),c},k=function(b){a.error("Failed to create session description: "+b.toString())},l=function(b){a.error("Failed to set session description: "+b.toString())},m=function(a,b,c){return function(f){f.sdp=d.maybePreferAudioReceiveCodec(f.sdp),f.sdp=d.maybeSetAudioReceiveBitRate(f.sdp),f.sdp=d.maybeSetVideoReceiveBitRate(f.sdp),a.setLocalDescription(f,i,l),e.sendMessageToClientFn("sdp",f,b,c)}},n=function(a,c){var d=function(){var e=f.remoteStream[c].getVideoTracks();0===e.length||a.remoteMiniVideoElem.currentTime>0||b(d,100)};d()},o={doAnswer:function(b,c){a.log("Sending answer to peer."),f.pc[c].createAnswer(m(f.pc[c],b,c),k,g.sdpConstraints)},doCall:function(b,c){var d=j(h.offerConstraints,g.sdpConstraints);a.log("Sending offer to peer, with constraints: \n  '"+JSON.stringify(d)+"'."),f.pc[c].createOffer(m(f.pc[c],b,c),k,d)},setRemote:function(b,e,g,i){var j=function(){a.log("Set remote session description success."),f.remoteStream[i]?n(g,i):a.log("Not receiving any stream.")};h.stereo&&(b.sdp=d.addStereo(b.sdp)),b.sdp=d.maybePreferAudioSendCodec(b.sdp),b.sdp=d.maybeSetAudioSendBitRate(b.sdp),b.sdp=d.maybeSetVideoSendBitRate(b.sdp),b.sdp=d.maybeSetVideoSendInitialBitRate(b.sdp),f.pc[i].setRemoteDescription(new c.RTCSessionDescription(b),j,l)}};return o}]),webRtcServices.service("lxWebRtcSessionService",["$log","$window","$rootScope","$timeout","lxMessageService","lxCodecsService","lxChatRoomVarsService","lxSessionDescriptionService","lxIceService","lxPeerService","lxChannelMessageService","lxAdapterService",function(a,b,c,d,e,f,g,h,i,j,k,l){var m=function(b,c){a.log("Session terminated."),b.stop(b,c)},n={webRtcSessionStarted:{},signalingReady:{},stop:function(a){n.webRtcSessionStarted[a]=!1,n.signalingReady[a]=!1,j.pc[a]&&j.pc[a].close(),delete j.pc[a],delete j.remoteStream[a],k.clearQueue(a)},processSignalingMessage:function(b,c,d,e,f){if(!n.webRtcSessionStarted[f])return void a.warn("peerConnection has not been created yet!");if("offer"===b.type)h.setRemote(b,c,d,f),h.doAnswer(e,f);else if("answer"===b.type)h.setRemote(b,c,d,f);else if("candidate"===b.type){var g=new l.RTCIceCandidate({sdpMLineIndex:b.label,candidate:b.candidate});i.noteIceCandidate("Remote",i.iceCandidateType(b.candidate)),j.pc[f].addIceCandidate(g,i.onAddIceCandidateSuccess,i.onAddIceCandidateError)}else"bye"===b.type&&m(this,c)}};return n}]),webRtcServices.factory("lxPeerService",["$log","lxAdapterService","lxChatRoomVarsService","lxIceService","lxJs","lxVideoParamsService",function(a,b,c,d,e,f){var g=function(a){var b="";return a&&(b+="Gathering: "+a.iceGatheringState+"\n",b+="PC State:\n",b+="Signaling: "+a.signalingState+"\n",b+="ICE: "+a.iceConnectionState+"\n"),b},h=function(c,d,e){return function(d){a.log("Remote stream added."),a.log("* remoteVideoObject.remoteMiniVideoElem.src before: "+c.remoteMiniVideoElem.src),b.attachMediaStream(c.remoteMiniVideoElem,d.stream),a.log("* remoteVideoObject.remoteMiniVideoElem.src after: "+c.remoteMiniVideoElem.src),l.remoteStream[e]=d.stream}},i=function(b){return function(){l.remoteStream[b]=null,a.info("Remote stream removed.")}},j=function(b){return function(){a.info("onSignalingStateChanged"),a.info(g(b))}},k=function(b){return function(){a.info("onIceConnectionStateChanged"),a.info(g(b))}},l={pc:{},remoteStream:{},createPeerConnection:function(c,g,m,n){a.log("**************** createPeerConnection ************");try{e.assert(m,"clientId is not set"),e.assert(n,"remoteClientId is not set"),l.pc[n]=new b.RTCPeerConnection(f.pcConfig,f.pcConstraints),l.pc[n].onicecandidate=d.onIceCandidate(m,n),a.log("Created RTCPeerConnnection to client:'"+n+"' with:\n  config: '"+JSON.stringify(f.pcConfig)+"';\n  constraints: '"+JSON.stringify(f.pcConstraints)+"'.")}catch(o){return o.message="\n	Failed to create PeerConnection\n	"+o.message,void a.error(o)}l.pc[n].onaddstream=h(c,g,n),l.pc[n].onremovestream=i(n),l.pc[n].onsignalingstatechange=j(l.pc[n]),l.pc[n].oniceconnectionstatechange=k(l.pc[n])},removeLocalVideoStream:function(){a.error("This functionality is not supported by Firefox as of Aug 18 2014, and therefore should not be used.")},addLocalVideoStream:function(b,c){l.pc[c]?l.pc[c].addStream(b):a.error("Error: no peer connection has been established, and therefore we cannot add the stream to it.")}};return l}]),webRtcServices.factory("lxStreamService",function(){var a={localStream:null,getLocalStream:function(){return a.localStream},getLocalStreamBoolean:function(){return!!a.localStream}};return a}),webRtcServices.factory("lxMediaService",["$log","$rootScope","$timeout","lxAdapterService","lxCallService","lxVideoParamsService","lxStreamService",function(a,b,c,d,e,f,g){var h=function(c){var f=c.localVideoObject,h=c.videoSignalingObject;return function(i){a.log("User has granted access to local media."),d.attachMediaStream(f.localMiniVideoElem,i),h.localUserAccessCameraAndMicrophoneStatus="allowAccess",c.videoDisplaySelection.currentlySelectedVideoElementId=c.videoStateInfoObject.currentOpenVideoSessionsList[0],g.localStream=i,e.setMicrophoneMute(f,f.isMicrophoneMuted),e.setWebcamMute(f,f.isWebcamMuted);for(var j in c.videoExchangeObjectsDict)c.videoExchangeObjectsDict.hasOwnProperty(j)&&e.maybeStart(c,j);b.$apply()}},i=function(b){return function(d){var f={};angular.extend(f,d);var g="\n	Failed to get access to local media. Error was "+d.toString()+angular.toJson(d)+". Continuing without sending a stream.\n	";f.message=g+d.message,a.error(f),c(function(){e.hasAudioOrVideoMediaConstraints=!1,b.localUserAccessCameraAndMicrophoneStatus="denyAccess"})}};return{doGetUserMedia:function(b){var c=b.videoSignalingObject;try{"waitingForResponse"!==c.localUserAccessCameraAndMicrophoneStatus?(d.getUserMedia(f.mediaConstraints,h(b),i(c)),a.debug("Requested access to local media with mediaConstraints:\n  '"+JSON.stringify(f.mediaConstraints)+"'"),c.localUserAccessCameraAndMicrophoneStatus="waitingForResponse"):a.debug("getUserMedia request has already been made, and so we are not making a new call to getUserMedia")}catch(e){e.message="\n	Error in doGetUserMedia\n	"+e.message,a.error(e),c.localUserAccessCameraAndMicrophoneStatus="denyAccess"}}}}]),webRtcServices.factory("lxCallService",["$log","lxTurnSupportService","lxPeerService","lxWebRtcSessionService","lxVideoParamsService","lxChatRoomVarsService","lxChannelMessageService","lxStreamService","lxSessionDescriptionService",function(a,b,c,d,e,f,g,h,i){var j=function(a,b,c,e){for(;g.getQueueLength(e)>0;)d.processSignalingMessage(g.shift(e),a,b,c,e)},k={hasAudioOrVideoMediaConstraints:!1,maybeStart:function(e,f){a.log("************ Entering maybeStart *************");var g=e.localVideoObject,l=e.remoteVideoElementsDict[f],m=e.videoSignalingObject,n=e.lxMainViewCtrl.clientId;!d.webRtcSessionStarted[f]&&d.signalingReady[f]&&e.channelObject.channelIsAlive&&b.turnDone&&(h.localStream||!k.hasAudioOrVideoMediaConstraints)?(a.debug("Starting webRtc services!!"),c.createPeerConnection(l,m,n,f),k.hasAudioOrVideoMediaConstraints?(a.log("Adding local stream."),c.addLocalVideoStream(h.localStream,f)):a.log("Not sending any stream."),d.webRtcSessionStarted[f]=!0,e.videoExchangeObjectsDict[f].rtcInitiator?(a.log("Executing doCall()"),i.doCall(n,f)):(a.log("Executing calleeStart()"),j(g,l,n,f))):(a.debug("Not ready to start webRtc services."),d.webRtcSessionStarted[f]&&a.debug("Because lxWebRtcSessionService.webRtcSessionStarted[remoteClientId] is true for remoteClientId: "+f),d.signalingReady[f]||a.debug("Because lxWebRtcSessionService.signalingReady[remoteClientId is false for remoteClientId: "+f),e.channelObject.channelIsAlive||a.debug("Because scope.channelObject.channelIsAlive is false"),b.turnDone||a.debug("Because lxTurnSupportService.turnDone is false"),h.localStream||a.debug("Because lxStreamService.localStream is false"))},doHangup:function(b,c){a.log("Hanging up client ID: "+b),0===c&&h.localStream&&(h.localStream.stop(),h.localStream=null),d.stop(b)},setWebcamMute:function(b,c){var d;if(b.isWebcamMuted=c,h.localStream){var e=h.localStream.getVideoTracks();if(0===e.length)return void a.log("No local video available.");if(b.isWebcamMuted){for(d=0;d<e.length;d++)e[d].enabled=!1;a.log("Video muted.")}else{for(d=0;d<e.length;d++)e[d].enabled=!0;a.log("Video unmuted.")}}},toggleWebcamMute:function(a){k.setWebcamMute(a,!a.isWebcamMuted)},setMicrophoneMute:function(b,c){var d;if(b.isMicrophoneMuted=c,h.localStream){var e=h.localStream.getAudioTracks();if(0===e.length)return void a.log("No local audio available.");if(b.isMicrophoneMuted){for(d=0;d<e.length;d++)e[d].enabled=!1;a.log("Audio muted.")}else{for(d=0;d<e.length;d++)e[d].enabled=!0;a.log("Audio unmuted.")}}},toggleMicrophoneMute:function(a){k.setMicrophoneMute(a,!a.isMicrophoneMuted)},setAudioMute:function(a,b){a.isAudioMuted=b,a.remoteMiniVideoElem.muted=a.isAudioMuted},toggleAudioMute:function(a){k.setAudioMute(a,!a.isAudioMuted)}};return k}]);var lxSelectVideoTypePreferenceServices=angular.module("lxVideoNegotiation.services",[]);lxSelectVideoTypePreferenceServices.factory("lxAccessVideoElementsAndAccessCameraService",["lxMessageService","lxJs",function(a,b){return{sendStatusOfVideoElementsEnabled:function(c,d,e){b.assert(e,"toClientId is not set");
var f={videoElementsEnabledAndCameraAccessRequested:d};a.sendMessageToClientFn("videoExchangeStatusMsg",f,c.lxMainViewCtrl.clientId,e)}}}]),angular.module("lxChatbox.directives",[]).directive("lxSetChatPanelMessageVisibilityDirective",function(){return{restrict:"A",link:function(a,b){a.$watch(function(){var b=a.chatboxPanelElementObject.videoIsFocused.toString()+a.chatboxPanelElementObject.showFullChatHistory.toString()+a.videoStateInfoObject.numOpenVideoExchanges.toString();return b},function(){var c="cl-chat-panel-show-full-chat-history",d="cl-chat-panel-show-partial-chat-history";b.removeClass(c),b.removeClass(d),a.chatboxPanelElementObject.showFullChatHistory||0===a.videoStateInfoObject.numOpenVideoExchanges?b.addClass(c):a.chatboxPanelElementObject.videoIsFocused||b.addClass(d)})}}}).directive("lxHandleMouseEventsInChatPanel",["$log",function(a){return{restrict:"A",link:function(b,c){var d=function(c){var d=$(c.target);a.log(d.attr("class")),d.hasClass("cl-bubble")||d.hasClass("cl-chat-message-time")?(a.debug("bubble event detected"),c.stopPropagation()):b.$apply(function(){b.chatboxPanelElementObject.videoIsFocused=!0})},e="mousedown.lxHandleMouseEventsInChatPanel  touchstart.lxHandleMouseEventsInChatPanel click.lxHandleMouseEventsInChatPanel";c.on(e,d),b.$on("$destroy",function(){c.off(e,d)})}}}]).directive("lxShowChatMessagesDirective",["$compile","$log","$timeout","lxShowNumMessagesService","lxSoundService","lxTimeService","lxWindowFocus",function(a,b,c,d,e,f,g){return{restrict:"A",link:function(a,b){var c,e,h=a.roomOccupancyObject.chatRoomId,i=function(a,d,e){for(var g,h,i=3,j=.75,k=i;k>0;k--)if(g="id-most-recent-message-div-"+k,h=b.find("#"+g),h.length>0)if(k===i)h.removeAttr("id"),h.css("display","none");else{var l="id-most-recent-message-div-"+(k+1);h.attr("id",l),h.css("opacity",j*(1-k/i))}g="id-most-recent-message-div-1",h=angular.element('<div  class="row cl-chat-row cl-chat-message-div">'),h.attr("id",g),h.css("opacity",j);var m="";e||(m="cl-bubble-error"),c=f.getTimeString(),h.append(angular.element('<div class="col-xs-12">').append(angular.element('<div class="cl-bubble cl-bubble-'+d+" "+m+'"><i></i>').append(a.messageString).append(angular.element('<span class="cl-chat-message-time">').append("&nbsp;&nbsp;"+c)))),b.append(h)};a.$watch("sendMessageTime",function(){a.sendMessagePayload.messageString&&i(a.sendMessagePayload,"right",a.sendMessagePayload.transmittedToServer)}),a.$watch(function(a){return a.receivedChatMessageObject[h].receivedMessageTime},function(){a.receivedChatMessageObject[h].messageString&&(i(a.receivedChatMessageObject[h],"left",!0),a.chatPanelDict[h].chatPanelIsCurrentlyVisible&&!a.chatboxPanelElementObject.videoIsFocused&&g.windowIsFocusedFn()||(a.chatPanelDict[h].numMessagesSinceLastTimeBottomOfPanelWasViewed++,a.trackUnseenMessageCountObject.unseenMessageCount++),d.showNumMessagesInDocumentTitle(a.trackUnseenMessageCountObject))}),a.$watch("channelObject.channelIsAlive",function(a,b){a===!1&&(e={messageString:"Internet/Server error. Your connection to ChatSurfing is not functioning correctly. Messages sent to you while your connection is down are permanently lost.",messageUniqueId:"Not set",transmittedToServer:!1},i(e,"left",e.transmittedToServer)),b===!1&&a&&(e={messageString:"Your connection to ChatSurfing appears to be working again",messageUniqueId:"Not set",transmittedToServer:!0},i(e,"left",e.transmittedToServer))})}}}]);var commonDirectives=angular.module("lxCommon.directives",[]);commonDirectives.directive("lxCheckIfSystemSupportsWebRtcDirective",["lxCheckIfSystemSupportsWebRtcService",function(a){return{restrict:"A",scope:{},link:function(b){a.checkBrowserVersionToSeeIfGetUserMediaSupported(b)}}}]),commonDirectives.directive("lxClickOnceDirective",["$timeout",function(a){var b=500;return{restrict:"A",priority:-1,link:function(c,d){function e(c){f?(c.preventDefault(),c.stopImmediatePropagation()):(f=!0,a(function(){f=!1},b,!1))}var f=!1;c.$on("$destroy",function(){d.off("click",e)}),d.on("click",e)}}}]),commonDirectives.factory("clickAnywhereButHereService",["$document","$log","$timeout",function(a,b,c){var d=null,e=!1;return{handleOuterClick:function(c,f){var g=function(){b.log("executing handleOuterClick: "+f),c.$apply(f)};e||a.on("click.clickAnywhereButHereDocument",g),c.$on("$destroy",function(){a.off("click.clickAnywhereButHereDocument",g)}),d=g},temporarilyDisableHandleOuterClick:function(){a.off("click.clickAnywhereButHereDocument",d),e=!0,c(function(){a.on("click.clickAnywhereButHereDocument",d),e=!1},50)}}}]),commonDirectives.directive("clickAnywhereButHere",["$log","clickAnywhereButHereService",function(a,b){return{restrict:"A",link:function(c,d,e){var f=function(b){a.log("clickAnywhereButHere stopping click propagation."),b.stopPropagation()};d.on("click.clickAnywhereButHereElem",f),c.$on("$destroy",function(){d.off("click.clickAnywhereButHereElem",f)}),a.log("executing clickAnywhereButHere"+e.clickAnywhereButHere),b.handleOuterClick(c,e.clickAnywhereButHere)}}}]),commonDirectives.directive("lxClickHereDirective",["$log",function(a){return{restrict:"A",link:function(b,c,d){var e=function(){a.log("executing lxClickHereDirective: "+d.lxClickHereDirective),b.$apply(d.lxClickHereDirective)};a.log("executing lxClickHereDirective"+d.lxClickHereDirective),c.on("click.lxClickHereDirective",e),b.$on("$destroy",function(){c.off("click.lxClickHereDirective",e)})}}}]),commonDirectives.directive("setClassesForCommonArea",function(){return{restrict:"A",link:function(a,b){function c(){a.mainMenuObject.showMainMenu||a.notificationMenuObject.partialShowNotificationMenuAndGetAttention?a.mainMenuObject.showMainMenu?(b.removeClass(e),b.removeClass(g),b.addClass(f)):a.notificationMenuObject.partialShowNotificationMenuAndGetAttention&&(b.removeClass(e),b.removeClass(f),b.addClass(g)):(b.removeClass(f),b.removeClass(g),b.addClass(e))}function d(a){a?$("body").addClass("cl-body-notification-pending"):$("body").removeClass("cl-body-notification-pending")}var e="col-xs-12",f="col-xs-12 col-xs-offset-4 col-sm-9 col-sm-offset-3 col-md-10 col-md-offset-2",g="col-xs-9 cl-col-remove-right-padding";a.$watch("mainMenuObject.showMainMenu",function(){c()}),a.$watch("notificationMenuObject.partialShowNotificationMenuAndGetAttention",function(a){c(),d(a)})}}}),commonDirectives.directive("lxDisableNgAnimate",["$animate",function(a){return{restrict:"A",link:function(b,c){a.enabled(!1,c)}}}]),commonDirectives.directive("lxNoSwipePropagation",["$log",function(){return{restrict:"A",link:function(a,b){var c=function(a){a.stopPropagation()},d="mousedown.lxNoSwipePropagation mousemove.lxNoSwipePropagation touchstart.lxNoSwipePropagation touchend.lxNoSwipePropagation";b.on(d,c),a.$on("$destroy",function(){b.off(d,c)})}}}]);var videoAppDirectives=angular.module("lxMainVideo.directives",[]);videoAppDirectives.directive("lxShowMiniVideoElementDirective",["$compile","lxAdapterService",function(a,b){return{restrict:"A",transclude:!0,template:"<div ng-transclude></div>",link:function(a,c){var d=a.clientId;if("localVideoElement"===d)c.append(a.localVideoObject.localMiniVideoElem),b.reattachMediaStream(a.localVideoObject.localMiniVideoElem,a.localVideoObject.localMiniVideoElem);else{var e=a.remoteVideoElementsDict[d];c.append(e.remoteMiniVideoElem),b.reattachMediaStream(e.remoteMiniVideoElem,e.remoteMiniVideoElem)}}}}]),videoAppDirectives.directive("lxMainVideoElementDirective",["lxAdapterService","lxPeerService","lxStreamService",function(a,b,c){return{restrict:"A",link:function(d,e){var f='<video class="cl-video cl-video-sizing" autoplay="autoplay" muted="true"></video>',g=angular.element(f),h=g[0];e.append(g),d.$watch(function(){var a,e=d.videoDisplaySelection.currentlySelectedVideoElementId;return a="localVideoElement"===e?!!c.localStream:!!b.remoteStream[e],e+a.toString()},function(){var b=d.videoDisplaySelection.currentlySelectedVideoElementId;if("localVideoElement"===b)a.reattachMediaStream(h,d.localVideoObject.localMiniVideoElem);else{var c=d.remoteVideoElementsDict[b];a.reattachMediaStream(h,c.remoteMiniVideoElem)}})}}}]),angular.module("lxChatRoom.directives",[]).directive("lxInitializeTurnDirective",["$log","lxTurnService",function(a,b){return{restrict:"A",link:function(){try{b.maybeRequestTurn()}catch(c){return c.message="\n	Error in lxInitializeTurnDirective\n	"+c.message,a.error(c),!1}}}}]).directive("lxAccessCameraAndMicrophoneDirective",["lxAccessCameraAndMicrophoneService",function(a){return{restrict:"A",link:function(b){a.showModalsAndArrowsForGrantingCameraAndMicrophoneAccess(b)}}}]).directive("lxShowUnseenMessageCountDirective",["lxShowNumMessagesService","lxWindowFocus",function(a,b){return{restrict:"A",link:function(c){c.$watch(function(){return b.windowIsFocusedFn()},function(b){b===!0&&(a.stopFlashingTitle(),a.showNumMessagesInDocumentTitle(c.trackUnseenMessageCountObject))})}}}]).directive("lxPartialShowNotificationMenuDirective",function(){return{restrict:"A",link:function(a){a.$watch("videoStateInfoObject.numVideoRequestsPendingFromRemoteUsers",function(b,c){b>0&&b>c&&(a.notificationMenuObject.showNotificationMenu||(a.notificationMenuObject.partialShowNotificationMenuAndGetAttention=!0)),0===b&&(a.notificationMenuObject.partialShowNotificationMenuAndGetAttention=!1,c>0&&(a.notificationMenuObject.showNotificationMenu=!1))})}}}).directive("lxWatchForErrorEnteringIntoRoom",["lxModalSupportService",function(a){return{restrict:"A",link:function(b){b.$watch("mainGlobalControllerObj.errorEnteringIntoRoomInfoObj",function(c){null!==c&&(a.showStandardModalWindowFromTemplate('<div class="modal-header"><h3 class="modal-title">Error entering into room '+c.pageNameThatCausedError+'</h3><div class="modal-body">Unable to enter into room: <strong>'+c.pageNameThatCausedError+"</strong> due to error code: "+c.statusString+'<br><a ng-click="modalOkFn()" href='+c.pageUrlThatCausedError+'>Try Again </a></div><div class="modal-footer"><button class="btn btn-primary" ng-click="modalOkFn()">Close</button></div></div>'),b.mainGlobalControllerObj.errorEnteringIntoRoomInfoObj=null)})}}}]),angular.module("lxLandingPage.directives",[]).directive("checkForRoomOccupancyDirective",["$log","lxHttpHandleRoomService","lxLandingPageConstantsService","lxDelayActionService",function(a,b,c,d){var e=300,f=d.getDelayFn();return{require:"ngModel",link:function(c,d,g,h){var i=angular.element(d)[0];c.$watch(function(){return i.value},function(){var c=null;h.$setValidity("networkOrServerError",!0),h.userIsWaitingForRoomStatus=!0,h.roomNumOccupantsMessage="",h.roomIsEmptyMessage="",h.$valid?i.value&&f(function(){c=b.checkIfRoomExists(i.value),a.debug("checkIfRoomExists called for: "+i.value),c.then(function(b){if(b.data.chatRoomName===i.value.toLowerCase())if(b.data.roomIsRegistered===!1||0===b.data.numInRoom)h.roomIsEmptyMessage="Chat room name is available!",h.submitButtonText="Create!";else{var c="Chat "+b.data.chatRoomName+" has "+b.data.numInRoom+" occupant",d=c+"s";h.roomNumOccupantsMessage=1===b.data.numInRoom?c:d,h.submitButtonText="Join!"}else a.warn("Warning: chat room name "+b.data.chatRoomName+" returned from server does not match most recently typed room name "+i.value)},function(b){h.$setValidity("networkOrServerError",!1),a.error("checkForRoomOccupancy - Error: "+b.statusText)})["finally"](function(){h.userIsWaitingForRoomStatus=!1})},e):h.submitButtonText="Enter!"})}}}]);var lxSelectVideoTypePreferenceDirectives=angular.module("lxVideoExchangeUserFeedback.directives",[]),showMessageInVideoWindow=function(a,b,c,d){b.removeClass("ng-hide"),b.html("");var e=angular.element("<span/>");e.html(c);var f=d(e)(a);b.append(f)},hideMessageInVideoWindow=function(a,b){b.addClass("ng-hide")};lxSelectVideoTypePreferenceDirectives.directive("lxDisplayRemoteVideoStatus",["$compile","$log","lxPeerService",function(a,b,c){return{restrict:"A",link:function(b,d,e){function f(){var a=e.selectedVideoElementId;try{return a+b.videoExchangeObjectsDict[a].remoteVideoEnabledSetting+(!!c.remoteStream[a]).toString()}catch(d){return null}}function g(){try{var a=e.selectedVideoElementId;return c.pc[a].iceConnectionState}catch(b){return null}}var h,i=d;b.$watch(f,function(d){if(null!==d){var f=e.selectedVideoElementId,g=!!c.remoteStream[f];hideMessageInVideoWindow(b,i);var j=b.videoExchangeObjectsDict[f].remoteVideoEnabledSetting;if(!g)switch(j){case"waitingForPermissionToEnableVideoExchange":h="Waiting for user "+f+" to agree to exchange video",showMessageInVideoWindow(b,i,h,a);break;case"denyVideoExchange":h=f+" has denied your request to exchange video",showMessageInVideoWindow(b,i,h,a);break;case"hangupVideoExchange":h=f+" has closed this video exchange. However, a new video session will start immediately if they call you again. If you do not want this to happen, you should press the hang-up button now.",showMessageInVideoWindow(b,i,h,a);break;case"doVideoExchange":h="Establishing video connection with "+f,showMessageInVideoWindow(b,i,h,a)}}}),b.$watch(g,function(c){"disconnected"===c&&(hideMessageInVideoWindow(b,i),h="The video connection has been lost",showMessageInVideoWindow(b,i,h,a))})}}}]),lxSelectVideoTypePreferenceDirectives.directive("lxDisplayLocalVideoStatus",["lxStreamService","$compile",function(a,b){return{restrict:"A",link:function(c,d){var e,f=d,g=function(){return!!a.localStream};c.$watch(g,function(a){a?hideMessageInVideoWindow(c,f):(e='<a href="" ng-click="showCameraAndMicrophoneInstructions()">Click here</a> to to activate video. ',showMessageInVideoWindow(c,f,e,b))})}}}]);